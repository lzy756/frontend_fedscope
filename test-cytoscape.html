<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cytoscape.js æ‹“æ‰‘å›¾æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #1890ff;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        button.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        #cy {
            width: 100%;
            height: 600px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            background: linear-gradient(135deg, #f0f2f5 0%, #ffffff 100%);
        }
        
        .info-panel {
            margin-top: 20px;
            padding: 16px;
            background: #fafafa;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 16px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ åˆ†ç°‡è”é‚¦å­¦ä¹ æ‹“æ‰‘å›¾ (Cytoscape.js)</h1>
        
        <div class="controls">
            <button onclick="changeLayout('concentric')" class="active" id="btn-concentric">åŒå¿ƒåœ†å¸ƒå±€</button>
            <button onclick="changeLayout('dagre')" id="btn-dagre">å±‚æ¬¡å¸ƒå±€</button>
            <button onclick="changeLayout('grid')" id="btn-grid">ç½‘æ ¼å¸ƒå±€</button>
            <button onclick="changeLayout('cola')" id="btn-cola">Colaå¸ƒå±€</button>
            <button onclick="startAnimation()">å¼€å§‹è®­ç»ƒåŠ¨ç”»</button>
            <button onclick="stopAnimation()">åœæ­¢åŠ¨ç”»</button>
            <button onclick="resetView()">é‡ç½®è§†å›¾</button>
            <button onclick="fitView()">é€‚åº”è§†å›¾</button>
        </div>
        
        <div id="cy"></div>
        
        <div class="info-panel">
            <h3>ğŸ”§ å½“å‰çŠ¶æ€</h3>
            <div id="status">
                <strong>è®­ç»ƒè½®æ¬¡:</strong> <span id="round">1</span> | 
                <strong>å‚ä¸å®¢æˆ·ç«¯:</strong> <span id="active-clients">15</span> | 
                <strong>å¸ƒå±€ç±»å‹:</strong> <span id="layout-type">concentric</span>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #722ed1; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); border-radius: 0;"></div>
                <span>FedSAKèšåˆå™¨ (L3)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1890ff; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); border-radius: 0;"></div>
                <span>ç°‡ä»£ç† (L2)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1890ff; opacity: 0.3; border-style: dashed;"></div>
                <span>å®¢æˆ·ç«¯ç°‡ (L1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #52c41a;"></div>
                <span>å‚ä¸è®­ç»ƒå®¢æˆ·ç«¯</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #d9d9d9;"></div>
                <span>åœ¨çº¿å®¢æˆ·ç«¯</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff4d4f;"></div>
                <span>ç¦»çº¿å®¢æˆ·ç«¯</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/cytoscape@3.32.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-cola@2.5.1/cytoscape-cola.js"></script>
    <script>
        let cy;
        let animationTimer;
        let currentRound = 1;

        // ç”Ÿæˆå››å±‚æ¶æ„æ•°æ®
        function generateTopologyData() {
            const nodes = [];
            const edges = [];
            
            // L3 - FedSAK Aggregator
            nodes.push({
                data: {
                    id: 'aggregator',
                    label: 'FedSAK\nèšåˆå™¨',
                    layer: 'L3',
                    type: 'aggregator'
                }
            });
            
            // L2 - Cluster Proxies & L1 - Cluster Groups
            for (let i = 1; i <= 3; i++) {
                // L2 ä»£ç†
                nodes.push({
                    data: {
                        id: `proxy_${i}`,
                        label: `ç°‡ä»£ç† ${i}`,
                        layer: 'L2',
                        type: 'proxy',
                        clusterId: i,
                        parent: `cluster_group_${i}`
                    }
                });
                
                // L1 ç°‡ç»„
                nodes.push({
                    data: {
                        id: `cluster_group_${i}`,
                        label: `å®¢æˆ·ç«¯ç°‡ C${i}`,
                        layer: 'L1',
                        type: 'cluster',
                        clusterId: i
                    }
                });
                
                // L3 -> L2 è¿æ¥
                edges.push({
                    data: {
                        id: `agg_to_proxy_${i}`,
                        source: 'aggregator',
                        target: `proxy_${i}`,
                        type: 'agg-proxy'
                    }
                });
            }
            
            // L0 - Clients
            const clientsPerCluster = [6, 7, 7];
            for (let clusterId = 1; clusterId <= 3; clusterId++) {
                const numClients = clientsPerCluster[clusterId - 1];
                
                for (let j = 1; j <= numClients; j++) {
                    const clientId = `client_${clusterId}_${j}`;
                    const isOnline = Math.random() > 0.1;
                    const isParticipating = isOnline && Math.random() > 0.3;
                    
                    nodes.push({
                        data: {
                            id: clientId,
                            label: `C${clusterId}-${j}`,
                            layer: 'L0',
                            type: 'client',
                            clusterId: clusterId,
                            parent: `cluster_group_${clusterId}`,
                            online: isOnline,
                            participating: isParticipating
                        }
                    });
                    
                    // L2 -> L0 è¿æ¥
                    if (isOnline) {
                        edges.push({
                            data: {
                                id: `proxy_to_client_${clientId}`,
                                source: `proxy_${clusterId}`,
                                target: clientId,
                                type: isParticipating ? 'cluster-client-active' : 'cluster-client-inactive'
                            }
                        });
                    }
                }
            }
            
            return { nodes, edges };
        }

        // è·å–æ ·å¼é…ç½®
        function getCytoscapeStyle() {
            return [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'color': '#fff',
                        'font-size': '10px',
                        'font-weight': 'bold',
                        'text-outline-width': 2,
                        'text-outline-color': '#000',
                        'text-wrap': 'wrap',
                        'text-max-width': '80px'
                    }
                },
                {
                    selector: 'node[layer="L3"]',
                    style: {
                        'background-color': '#722ed1',
                        'shape': 'hexagon',
                        'width': 60,
                        'height': 60,
                        'border-width': 4,
                        'border-color': '#531dab'
                    }
                },
                {
                    selector: 'node[layer="L2"]',
                    style: {
                        'background-color': (ele) => {
                            const clusterId = ele.data('clusterId');
                            const colors = ['#1890ff', '#52c41a', '#fa8c16'];
                            return colors[clusterId - 1] || '#1890ff';
                        },
                        'shape': 'diamond',
                        'width': 45,
                        'height': 45,
                        'border-width': 3,
                        'border-color': '#fff'
                    }
                },
                {
                    selector: 'node[layer="L1"]',
                    style: {
                        'background-color': (ele) => {
                            const clusterId = ele.data('clusterId');
                            const colors = ['#1890ff', '#52c41a', '#fa8c16'];
                            return (colors[clusterId - 1] || '#1890ff') + '20';
                        },
                        'border-width': 2,
                        'border-style': 'dashed',
                        'border-color': (ele) => {
                            const clusterId = ele.data('clusterId');
                            const colors = ['#1890ff', '#52c41a', '#fa8c16'];
                            return colors[clusterId - 1] || '#1890ff';
                        },
                        'padding': '30px',
                        'shape': 'round-rectangle',
                        'text-valign': 'top',
                        'text-margin-y': '-15px'
                    }
                },
                {
                    selector: 'node[layer="L0"]',
                    style: {
                        'background-color': (ele) => {
                            const online = ele.data('online');
                            const participating = ele.data('participating');
                            if (!online) return '#ff4d4f';
                            if (participating) return '#52c41a';
                            return '#d9d9d9';
                        },
                        'shape': 'ellipse',
                        'width': 28,
                        'height': 28,
                        'border-width': 2,
                        'border-color': '#fff',
                        'font-size': '8px'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#95a5a6',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#95a5a6',
                        'width': 2,
                        'curve-style': 'bezier'
                    }
                },
                {
                    selector: 'edge[type="agg-proxy"]',
                    style: {
                        'line-color': '#722ed1',
                        'target-arrow-color': '#722ed1',
                        'width': 4
                    }
                },
                {
                    selector: 'edge[type="cluster-client-active"]',
                    style: {
                        'line-color': '#52c41a',
                        'target-arrow-color': '#52c41a',
                        'width': 3
                    }
                },
                {
                    selector: 'edge[type="cluster-client-inactive"]',
                    style: {
                        'line-color': '#d9d9d9',
                        'target-arrow-color': '#d9d9d9',
                        'width': 1,
                        'opacity': 0.4
                    }
                }
            ];
        }

        // è·å–å¸ƒå±€é…ç½®
        function getLayoutConfig(type = 'concentric') {
            const layouts = {
                concentric: {
                    name: 'concentric',
                    concentric: (node) => {
                        const layer = node.data('layer');
                        return layer === 'L3' ? 4 : layer === 'L2' ? 3 : layer === 'L1' ? 2 : 1;
                    },
                    levelWidth: () => 1,
                    minNodeSpacing: 80,
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50
                },
                dagre: {
                    name: 'dagre',
                    rankDir: 'TB',
                    nodeSep: 50,
                    edgeSep: 10,
                    rankSep: 100,
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50
                },
                grid: {
                    name: 'grid',
                    rows: 4,
                    cols: 6,
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50
                },
                cola: {
                    name: 'cola',
                    animate: true,
                    randomize: false,
                    maxSimulationTime: 1500,
                    fit: true,
                    padding: 50,
                    nodeSpacing: (node) => 80,
                    edgeLength: 100
                }
            };
            
            return layouts[type] || layouts.concentric;
        }

        // åˆå§‹åŒ– Cytoscape
        function initCytoscape() {
            const { nodes, edges } = generateTopologyData();
            
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [...nodes, ...edges],
                style: getCytoscapeStyle(),
                layout: getLayoutConfig('concentric'),
                minZoom: 0.3,
                maxZoom: 3,
                wheelSensitivity: 0.3
            });

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            cy.on('tap', 'node', (evt) => {
                const node = evt.target;
                const nodeData = node.data();
                console.log('ç‚¹å‡»èŠ‚ç‚¹:', nodeData);
                
                // é«˜äº®é€‰ä¸­çš„èŠ‚ç‚¹
                cy.elements().removeClass('highlighted');
                node.addClass('highlighted');
                
                // é«˜äº®ç›¸é‚»è¾¹å’ŒèŠ‚ç‚¹
                node.neighborhood().addClass('highlighted');
            });

            updateStatus();
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            document.getElementById('round').textContent = currentRound;
            const activeCount = cy ? cy.nodes('[layer="L0"][participating="true"]').length : 0;
            document.getElementById('active-clients').textContent = activeCount;
        }

        // æ”¹å˜å¸ƒå±€
        function changeLayout(type) {
            if (!cy) return;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${type}`).classList.add('active');
            
            cy.layout(getLayoutConfig(type)).run();
            document.getElementById('layout-type').textContent = type;
        }

        // å¼€å§‹è®­ç»ƒåŠ¨ç”»
        function startAnimation() {
            if (animationTimer) clearInterval(animationTimer);
            
            animationTimer = setInterval(() => {
                simulateTrainingRound();
                currentRound++;
                updateStatus();
            }, 3000);
        }

        // åœæ­¢åŠ¨ç”»
        function stopAnimation() {
            if (animationTimer) {
                clearInterval(animationTimer);
                animationTimer = null;
            }
        }

        // æ¨¡æ‹Ÿè®­ç»ƒè½®æ¬¡
        function simulateTrainingRound() {
            if (!cy) return;

            // å®¢æˆ·ç«¯ä¸Šä¼ åŠ¨ç”»
            const activeClients = cy.nodes('[layer="L0"][participating="true"]');
            activeClients.forEach((client, index) => {
                setTimeout(() => {
                    client.animate({
                        style: { 'background-color': '#fff', 'width': 35, 'height': 35 }
                    }, {
                        duration: 300,
                        complete: () => {
                            client.animate({
                                style: { 'background-color': '#52c41a', 'width': 28, 'height': 28 }
                            }, { duration: 300 });
                        }
                    });
                }, index * 100);
            });

            // ä»£ç†èšåˆåŠ¨ç”»
            setTimeout(() => {
                const proxies = cy.nodes('[layer="L2"]');
                proxies.animate({
                    style: { 'background-color': '#faad14', 'width': 55, 'height': 55 }
                }, {
                    duration: 800,
                    complete: () => {
                        proxies.forEach(proxy => {
                            const clusterId = proxy.data('clusterId');
                            const colors = ['#1890ff', '#52c41a', '#fa8c16'];
                            proxy.animate({
                                style: { 
                                    'background-color': colors[clusterId - 1], 
                                    'width': 45, 
                                    'height': 45 
                                }
                            }, { duration: 300 });
                        });
                    }
                });
            }, 1000);

            // å…¨å±€èšåˆåŠ¨ç”»
            setTimeout(() => {
                const aggregator = cy.nodes('[layer="L3"]');
                aggregator.animate({
                    style: { 
                        'background-color': '#faad14', 
                        'width': 80, 
                        'height': 80 
                    }
                }, {
                    duration: 1000,
                    complete: () => {
                        aggregator.animate({
                            style: { 
                                'background-color': '#722ed1', 
                                'width': 60, 
                                'height': 60 
                            }
                        }, { duration: 500 });
                    }
                });
            }, 2000);
        }

        // é‡ç½®è§†å›¾
        function resetView() {
            if (!cy) return;
            cy.fit();
            cy.center();
        }

        // é€‚åº”è§†å›¾
        function fitView() {
            if (!cy) return;
            cy.fit();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initCytoscape();
        });
    </script>
</body>
</html>
